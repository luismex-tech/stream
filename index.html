<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RadioLink: Nombres Fijos</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #fff; text-align: center; padding: 20px; }
        .box { background: #1e1e1e; padding: 20px; border: 1px solid #333; max-width: 600px; margin: 0 auto; border-radius: 8px; }

        input, select { padding: 10px; width: 90%; background: #000; color: #0f0; border: 1px solid #444; margin: 5px 0; font-family: monospace; }
        label { display: block; text-align: left; margin-top: 10px; color: #aaa; font-size: 0.9em; }

        button { padding: 12px; width: 100%; cursor: pointer; background: #444; color: white; border: none; font-weight: bold; margin-top: 15px; }
        button.primary { background: #007bff; }
        button.live { background: #dc3545; animation: pulse 1.5s infinite; }
        button.connect { background: #28a745; }

        .section { padding: 15px; border-bottom: 1px solid #333; }
        .hidden { display: none; }

        /* Vumetro */
        #vu-meter { width: 0%; height: 10px; background: linear-gradient(90deg, #0f0, #ff0, #f00); transition: width 0.1s; margin-top: 5px; }
        .meter-box { width: 90%; background: #333; height: 10px; margin: 0 auto; }

        #status-log { font-family: monospace; font-size: 12px; color: #aaa; height: 80px; overflow-y: auto; text-align: left; background: #000; padding: 5px; margin-top: 10px; border: 1px solid #333; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="box">
        <h2>ðŸ“¡ RadioLink: Enlace P2P</h2>

        <div id="step-1" class="section">
            <label>1. Â¿QuiÃ©n eres tÃº? (Crea un nombre Ãºnico)</label>
            <input type="text" id="my-custom-id" placeholder="Ej: cabina-luismex" value="cabina-luismex">
            <button onclick="inicializarPeer()" class="primary">ðŸ”— CONECTARSE A LA RED</button>
            <p style="font-size: 0.8em; color: #666;">Usa nombres Ãºnicos para que nadie mÃ¡s los ocupe.</p>
        </div>

        <div id="step-2" class="section hidden">
            <h3 style="color: #4facfe;">Soy: <span id="display-id">...</span></h3>

            <hr style="border-color: #333;">

            <label>DESTINO (A quiÃ©n llamar):</label>
            <input type="text" id="remote-id" placeholder="Ej: movil-luismex">

            <label>CALIDAD:</label>
            <select id="bitrate">
                <option value="128">128 kbps (Radio FM)</option>
                <option value="256">256 kbps (Estudio)</option>
            </select>

            <button id="btn-call" onclick="llamar()" class="connect">ðŸ“ž LLAMAR Y TRANSMITIR</button>

            <label>Nivel de Audio:</label>
            <div class="meter-box"><div id="vu-meter"></div></div>
        </div>

        <div id="incoming-call" class="section hidden" style="background: #220;">
            <h3>ðŸ”” LLAMADA ENTRANTE</h3>
            <button onclick="contestar()" class="connect">ðŸ”Š CONTESTAR AL AIRE</button>
        </div>

        <div id="status-log"></div>
        <audio id="remote-audio"></audio>
    </div>

    <script>
        let peer;
        let localStream;
        let currentCall;
        let incomingRequest = null;
        let audioContext, analyser, microphone;

        function log(msg, error = false) {
            const box = document.getElementById('status-log');
            const color = error ? 'red' : '#0f0';
            box.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        // --- 1. INICIALIZAR CON NOMBRE FIJO ---
        function inicializarPeer() {
            const customId = document.getElementById('my-custom-id').value.trim();
            if(!customId) return alert("Escribe un nombre.");

            // Creamos el Peer con el ID que tÃº elegiste
            peer = new Peer(customId);

            peer.on('open', (id) => {
                log(`Conectado a la red como: ${id}`);
                document.getElementById('step-1').classList.add('hidden');
                document.getElementById('step-2').classList.remove('hidden');
                document.getElementById('display-id').innerText = id;
            });

            peer.on('error', (err) => {
                if (err.type === 'unavailable-id') {
                    alert("Â¡Ese nombre YA ESTÃ EN USO! Alguien mÃ¡s lo tiene abierto o tÃº mismo en otra pestaÃ±a. Elige otro nombre.");
                    log("Error: ID en uso.", true);
                } else if (err.type === 'peer-unavailable') {
                    log("âŒ ERROR: El destino no existe o no estÃ¡ conectado. Revisa el nombre.", true);
                    alert("El usuario al que llamas NO estÃ¡ conectado. Revisa que su pÃ¡gina estÃ© abierta y tenga el nombre correcto.");
                } else {
                    log("Error: " + err.type, true);
                }
            });

            // Preparar recepciÃ³n de llamadas
            peer.on('call', (call) => {
                incomingRequest = call;
                document.getElementById('incoming-call').classList.remove('hidden');
                log("Â¡Alguien te estÃ¡ llamando!");
            });
        }

        // --- 2. OBTENER MICROFONO (Robusto) ---
        async function getMic() {
            try {
                // Intento Hi-Fi
                return await navigator.mediaDevices.getUserMedia({
                    audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false }
                });
            } catch (e) {
                log("Hardware simple detectado. Usando modo estÃ¡ndar.");
                return await navigator.mediaDevices.getUserMedia({ audio: true });
            }
        }

        // --- 3. LLAMAR (TRANSMITIR) ---
        async function llamar() {
            const destId = document.getElementById('remote-id').value.trim();
            const bitrate = document.getElementById('bitrate').value;

            if(!destId) return alert("Escribe el nombre del destino");

            try {
                log("Abriendo micrÃ³fono...");
                localStream = await getMic();
                setupVuMeter(localStream);

                log(`Llamando a ${destId}...`);

                // Modificar SDP para bitrate
                const options = {
                    sdpTransform: (sdp) => sdp.replace(/a=fmtp:111.*/g, `a=fmtp:111 minptime=10;useinbandfec=1;maxaveragebitrate=${bitrate * 1000}`)
                };

                const call = peer.call(destId, localStream, options);

                call.on('stream', remoteStream => {
                    // Si el otro lado tambiÃ©n nos habla (Talkback)
                    document.getElementById('remote-audio').srcObject = remoteStream;
                    document.getElementById('remote-audio').play();
                });

                call.on('close', () => {
                    log("Llamada terminada.");
                    document.getElementById('btn-call').classList.remove('live');
                    document.getElementById('btn-call').innerText = "ðŸ“ž LLAMAR Y TRANSMITIR";
                });

                // UI Update
                document.getElementById('btn-call').classList.add('live');
                document.getElementById('btn-call').innerText = "ðŸ“¡ TRANSMITIENDO...";

            } catch (err) {
                log("Error MicrÃ³fono: " + err, true);
                alert("Error de acceso al micrÃ³fono. Revisa permisos (Candado ðŸ”’).");
            }
        }

        // --- 4. CONTESTAR (RECIBIR) ---
        function contestar() {
            if(!incomingRequest) return;

            document.getElementById('incoming-call').classList.add('hidden');

            // Contestamos (podemos enviar audio de regreso si queremos, aquÃ­ enviamos null para solo escuchar)
            incomingRequest.answer();

            incomingRequest.on('stream', (remoteStream) => {
                log("âœ… Audio Conectado. Al aire.");
                const audio = document.getElementById('remote-audio');
                audio.srcObject = remoteStream;
                audio.play();
                setupVuMeter(remoteStream);
            });
        }

        // --- VUMETRO ---
        function setupVuMeter(stream) {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') audioContext.resume();

            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(analyser);
            analyser.fftSize = 256;

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            function draw() {
                requestAnimationFrame(draw);
                analyser.getByteFrequencyData(dataArray);
                let sum = 0;
                for(let i=0; i<bufferLength; i++) sum += dataArray[i];
                let avg = sum / bufferLength;
                document.getElementById('vu-meter').style.width = (avg * 2.5) + '%';
            }
            draw();
        }
